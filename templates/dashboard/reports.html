{% extends "base.html" %}
{% block title %}Relatórios e Métricas{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4"><i class="fas fa-chart-bar"></i> Relatórios e Métricas</h1>
    
    <!-- Cards de Métricas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary">{{ total_tickets }}</h3>
                    <p>Total de Tickets</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info">
                        {% if tickets_by_status %}
                            {% for status, count in tickets_by_status %}
                                {% if status == 'open' or status == 'aberto' %}{{ count }}{% endif %}
                            {% endfor %}
                        {% else %}0{% endif %}
                    </h3>
                    <p>Tickets Abertos</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning">
                        {% if tickets_by_status %}
                            {% for status, count in tickets_by_status %}
                                {% if status == 'in_progress' or status == 'em_andamento' %}{{ count }}{% endif %}
                            {% endfor %}
                        {% else %}0{% endif %}
                    </h3>
                    <p>Em Andamento</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success">
                        {% if tickets_by_status %}
                            {% for status, count in tickets_by_status %}
                                {% if status == 'resolved' or status == 'resolvido' %}{{ count }}{% endif %}
                            {% endfor %}
                        {% else %}0{% endif %}
                    </h3>
                    <p>Resolvidos</p>
                </div>
            </div>
        </div>
    </div>
    
    {% if current_user.role == 'admin' and user_stats %}
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center bg-light">
                <div class="card-body">
                    <h4>{{ user_stats.total }}</h4>
                    <p class="mb-0">Total de Usuários</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-light">
                <div class="card-body">
                    <h4 class="text-success">{{ user_stats.active }}</h4>
                    <p class="mb-0">Usuários Ativos</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-light">
                <div class="card-body">
                    <h4 class="text-danger">{{ user_stats.admins }}</h4>
                    <p class="mb-0">Administradores</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-light">
                <div class="card-body">
                    <h4 class="text-warning">{{ user_stats.technicians }}</h4>
                    <p class="mb-0">Técnicos</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Gráficos -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-pie"></i> Tickets por Status</h5>
                </div>
                <div class="card-body">
                    <canvas id="statusChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> Tickets por Prioridade</h5>
                </div>
                <div class="card-body">
                    <canvas id="priorityChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-tags"></i> Tickets por Categoria</h5>
                </div>
                <div class="card-body">
                    <canvas id="categoryChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line"></i> Evolução Temporal</h5>
                </div>
                <div class="card-body">
                    <canvas id="timelineChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tabela Resumo -->
    <div class="card">
        <div class="card-header">
            <h5><i class="fas fa-table"></i> Resumo Detalhado</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Métrica</th>
                            <th>Valor</th>
                            <th>Detalhes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Taxa de Resolução</strong></td>
                            <td>
                                {% if total_tickets > 0 %}
                                    {% set resolved_count = 0 %}
                                    {% if tickets_by_status %}
                                        {% for status, count in tickets_by_status %}
                                            {% if status == 'resolved' or status == 'resolvido' %}
                                                {% set resolved_count = count %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    <span class="badge bg-success">{{ ((resolved_count / total_tickets) * 100)|round(1) }}%</span>
                                {% else %}
                                    <span class="badge bg-secondary">N/A</span>
                                {% endif %}
                            </td>
                            <td>{{ resolved_count|default(0) }} de {{ total_tickets }} tickets</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Aguarda o DOM carregar
document.addEventListener('DOMContentLoaded', function() {
    // Dados do backend
    const statusData = {{ tickets_by_status|default([])|tojson|safe }};
    const priorityData = {{ tickets_by_priority|default([])|tojson|safe }};
    const categoryData = {{ tickets_by_category|default([])|tojson|safe }};
    
    console.log('Status Data:', statusData);
    console.log('Priority Data:', priorityData);
    console.log('Category Data:', categoryData);
    
    // Gráfico de Status
    if (statusData && statusData.length > 0) {
        const statusCtx = document.getElementById('statusChart');
        if (statusCtx) {
            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: statusData.map(item => {
                        const status = item[0];
                        const labels = {
                            'open': 'Aberto',
                            'aberto': 'Aberto',
                            'in_progress': 'Em Andamento',
                            'em_andamento': 'Em Andamento',
                            'resolved': 'Resolvido',
                            'resolvido': 'Resolvido',
                            'closed': 'Fechado',
                            'fechado': 'Fechado'
                        };
                        return labels[status] || status;
                    }),
                    datasets: [{
                        data: statusData.map(item => item[1]),
                        backgroundColor: [
                            '#17a2b8', // Aberto - Azul
                            '#ffc107', // Em Andamento - Amarelo
                            '#28a745', // Resolvido - Verde
                            '#6c757d'  // Fechado - Cinza
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
    }
    
    // Gráfico de Prioridade
    if (priorityData && priorityData.length > 0) {
        const priorityCtx = document.getElementById('priorityChart');
        if (priorityCtx) {
            new Chart(priorityCtx, {
                type: 'bar',
                data: {
                    labels: priorityData.map(item => {
                        const priority = item[0];
                        const labels = {
                            'low': 'Baixa',
                            'baixa': 'Baixa',
                            'medium': 'Média',
                            'media': 'Média',
                            'high': 'Alta',
                            'alta': 'Alta',
                            'critical': 'Crítica',
                            'critica': 'Crítica'
                        };
                        return labels[priority] || priority;
                    }),
                    datasets: [{
                        label: 'Quantidade',
                        data: priorityData.map(item => item[1]),
                        backgroundColor: [
                            '#28a745', // Baixa - Verde
                            '#ffc107', // Média - Amarelo
                            '#fd7e14', // Alta - Laranja
                            '#dc3545'  // Crítica - Vermelho
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
    }
    
    // Gráfico de Categoria
    if (categoryData && categoryData.length > 0) {
        const categoryCtx = document.getElementById('categoryChart');
        if (categoryCtx) {
            new Chart(categoryCtx, {
                type: 'bar',
                data: {
                    labels: categoryData.map(item => item[0]),
                    datasets: [{
                        label: 'Quantidade',
                        data: categoryData.map(item => item[1]),
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
    }
    
    // Gráfico de Timeline (dados simulados)
    const timelineCtx = document.getElementById('timelineChart');
    if (timelineCtx) {
        const days = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'];
        const data = [2, 4, 3, 5, 7, 4, 6];
        
        new Chart(timelineCtx, {
            type: 'line',
            data: {
                labels: days,
                datasets: [{
                    label: 'Tickets Criados',
                    data: data,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
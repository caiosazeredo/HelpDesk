{% extends "base.html" %}
{% block title %}Relatórios - HelpDesk TI{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4"><i class="fas fa-chart-bar"></i> Relatórios e Métricas</h1>
    
    <!-- Cards de Métricas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary">{{ status_data|sum(attribute='1') }}</h3>
                    <p>Total de Tickets (30 dias)</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success">{{ sla_compliance.values()|sum / sla_compliance|length }}%</h3>
                    <p>Conformidade SLA Média</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning">{{ resolution_times|sum(attribute='1')|round / 60 }}h</h3>
                    <p>Tempo Médio Resolução</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info">{{ top_technicians|length }}</h3>
                    <p>Técnicos Ativos</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Gráficos -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Tickets por Status</h5>
                </div>
                <div class="card-body">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Tickets por Categoria</h5>
                </div>
                <div class="card-body">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Conformidade SLA por Prioridade</h5>
                </div>
                <div class="card-body">
                    <canvas id="slaChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Evolução Diária de Tickets</h5>
                </div>
                <div class="card-body">
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tabela Top Técnicos -->
    <div class="card">
        <div class="card-header">
            <h5><i class="fas fa-trophy"></i> Top Técnicos do Mês</h5>
        </div>
        <div class="card-body">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Posição</th>
                        <th>Técnico</th>
                        <th>Tickets Resolvidos</th>
                        <th>Avaliação Média</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tech in top_technicians %}
                    <tr>
                        <td>
                            {% if loop.index == 1 %}
                            <i class="fas fa-trophy text-warning"></i>
                            {% elif loop.index == 2 %}
                            <i class="fas fa-medal text-secondary"></i>
                            {% elif loop.index == 3 %}
                            <i class="fas fa-medal" style="color: #cd7f32;"></i>
                            {% else %}
                            {{ loop.index }}
                            {% endif %}
                        </td>
                        <td>{{ tech[0] }}</td>
                        <td>{{ tech[1] }}</td>
                        <td>
                            {% if tech[2] %}
                                {% for i in range((tech[2]|round)|int) %}
                                <i class="fas fa-star text-warning"></i>
                                {% endfor %}
                                ({{ tech[2]|round(1) }})
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Dados para os gráficos
const statusData = {{ status_data|tojson }};
const categoryData = {{ category_data|tojson }};
const slaCompliance = {{ sla_compliance|tojson }};
const dailyTickets = {{ daily_tickets|tojson }};

// Gráfico de Status
new Chart(document.getElementById('statusChart'), {
    type: 'doughnut',
    data: {
        labels: statusData.map(d => d[0].replace('_', ' ').toUpperCase()),
        datasets: [{
            data: statusData.map(d => d[1]),
            backgroundColor: ['#17a2b8', '#ffc107', '#28a745', '#6c757d']
        }]
    }
});

// Gráfico de Categorias
new Chart(document.getElementById('categoryChart'), {
    type: 'bar',
    data: {
        labels: categoryData.map(d => d[0].toUpperCase()),
        datasets: [{
            label: 'Tickets',
            data: categoryData.map(d => d[1]),
            backgroundColor: 'rgba(102, 126, 234, 0.6)'
        }]
    }
});

// Gráfico SLA
new Chart(document.getElementById('slaChart'), {
    type: 'horizontalBar',
    data: {
        labels: Object.keys(slaCompliance).map(k => k.toUpperCase()),
        datasets: [{
            label: 'Conformidade %',
            data: Object.values(slaCompliance),
            backgroundColor: Object.values(slaCompliance).map(v => 
                v >= 90 ? '#28a745' : v >= 70 ? '#ffc107' : '#dc3545'
            )
        }]
    },
    options: {
        scales: {
            xAxes: [{
                ticks: {
                    beginAtZero: true,
                    max: 100
                }
            }]
        }
    }
});

// Gráfico Diário
new Chart(document.getElementById('dailyChart'), {
    type: 'line',
    data: {
        labels: dailyTickets.map(d => d[0]),
        datasets: [{
            label: 'Tickets Criados',
            data: dailyTickets.map(d => d[1]),
            borderColor: 'rgba(102, 126, 234, 1)',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4
        }]
    }
});
</script>
{% endblock %}
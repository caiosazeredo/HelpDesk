{% extends "base.html" %}
{% block title %}Ticket #{{ ticket.id }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-8">
            <!-- Detalhes do Ticket -->
            <div class="card mb-4">
                <div class="card-header bg-gradient-primary text-white">
                    <h4>Ticket #{{ ticket.id }} - {{ ticket.title }}</h4>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <strong>Status:</strong><br>
                            <span class="badge bg-{{ ticket.status|status_color }}">
                                {{ ticket.status|replace('_', ' ')|upper }}
                            </span>
                        </div>
                        <div class="col-md-3">
                            <strong>Prioridade:</strong><br>
                            <span class="badge bg-{{ ticket.priority|priority_color }}">
                                {{ ticket.priority|upper }}
                            </span>
                        </div>
                        <div class="col-md-3">
                            <strong>Categoria:</strong><br>
                            <i class="fas {{ category_icons[ticket.category] }}"></i> 
                            {{ ticket.category|title }}
                        </div>
                        <div class="col-md-3">
                            <strong>Criado em:</strong><br>
                            {{ ticket.created_at.strftime('%d/%m/%Y %H:%M') }}
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="mb-3">
                        <strong>Descrição:</strong>
                        <p class="mt-2">{{ ticket.description }}</p>
                    </div>
                </div>
            </div>
            
            <!-- Comentários -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-comments"></i> Comentários</h5>
                </div>
                <div class="card-body">
                    {% for comment in comments %}
                    <div class="mb-3 p-3 {% if comment.is_internal %}bg-light border-start border-warning border-3{% endif %} rounded">
                        <div class="d-flex justify-content-between">
                            <strong>{{ comment.author.full_name }}</strong>
                            <small class="text-muted">
                                {{ comment.created_at.strftime('%d/%m/%Y %H:%M') }}
                                {% if comment.is_internal %}
                                <span class="badge bg-warning text-dark">Interno</span>
                                {% endif %}
                            </small>
                        </div>
                        <p class="mt-2 mb-0">{{ comment.content }}</p>
                    </div>
                    {% endfor %}
                    
                    <!-- Formulário de Comentário -->
                    <form method="POST" action="{{ url_for('add_comment', ticket_id=ticket.id) }}">
                        {{ comment_form.hidden_tag() }}
                        <div class="mb-3">
                            {{ comment_form.content(class="form-control", rows="3", placeholder="Adicionar comentário...") }}
                        </div>
                        {% if current_user.role in ['technician', 'admin'] %}
                        <div class="mb-3">
                            <div class="form-check">
                                {{ comment_form.is_internal(class="form-check-input") }}
                                {{ comment_form.is_internal.label(class="form-check-label") }}
                            </div>
                        </div>
                        {% endif %}
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> Enviar Comentário
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Informações -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle"></i> Informações</h5>
                </div>
                <div class="card-body">
                    <p><strong>Solicitante:</strong> {{ ticket.creator.full_name }}</p>
                    <p><strong>Departamento:</strong> {{ ticket.creator.department }}</p>
                    {% if ticket.technician %}
                    <p><strong>Técnico:</strong> {{ ticket.technician.full_name }}</p>
                    {% endif %}
                    {% if ticket.resolved_at %}
                    <p><strong>Resolvido em:</strong> {{ ticket.resolved_at.strftime('%d/%m/%Y %H:%M') }}</p>
                    {% endif %}
                    {% if ticket.resolution_time %}
                    <p><strong>Tempo de Resolução:</strong> 
                        {% if ticket.resolution_time < 60 %}
                            {{ ticket.resolution_time }} minutos
                        {% else %}
                            {{ (ticket.resolution_time / 60)|round(1) }} horas
                        {% endif %}
                    </p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Ações -->
            {% if current_user.role in ['technician', 'admin'] %}
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-cogs"></i> Ações</h5>
                </div>
                <div class="card-body">
                    {% if ticket.status == 'open' and not ticket.assigned_to %}
                    <button onclick="assignTicket({{ ticket.id }})" class="btn btn-success btn-sm mb-2 w-100">
                        <i class="fas fa-user-check"></i> Assumir Ticket
                    </button>
                    {% endif %}
                    
                    {% if ticket.status != 'resolved' and ticket.status != 'closed' %}
                    <button onclick="updateStatus({{ ticket.id }}, 'in_progress')" 
                            class="btn btn-warning btn-sm mb-2 w-100 {% if ticket.status == 'in_progress' %}disabled{% endif %}">
                        <i class="fas fa-spinner"></i> Em Andamento
                    </button>
                    <button onclick="updateStatus({{ ticket.id }}, 'resolved')" class="btn btn-success btn-sm mb-2 w-100">
                        <i class="fas fa-check"></i> Resolver
                    </button>
                    {% endif %}
                    
                    {% if ticket.status == 'resolved' %}
                    <button onclick="updateStatus({{ ticket.id }}, 'closed')" class="btn btn-secondary btn-sm w-100">
                        <i class="fas fa-times"></i> Fechar Ticket
                    </button>
                    {% endif %}
                    
                    {% if ticket.status == 'closed' or ticket.status == 'resolved' %}
                    <button onclick="updateStatus({{ ticket.id }}, 'open')" class="btn btn-info btn-sm w-100 mt-2">
                        <i class="fas fa-redo"></i> Reabrir Ticket
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function assignTicket(ticketId) {
    if (!confirm('Deseja assumir este ticket?')) return;
    
    fetch(`/tickets/${ticketId}/assign`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message || 'Ticket assumido com sucesso!');
            location.reload();
        } else {
            alert(data.error || 'Erro ao assumir ticket');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao assumir ticket');
    });
}

function updateStatus(ticketId, status) {
    const statusText = {
        'open': 'Aberto',
        'in_progress': 'Em Andamento',
        'resolved': 'Resolvido',
        'closed': 'Fechado'
    };
    
    if (!confirm(`Alterar status para ${statusText[status]}?`)) return;
    
    fetch(`/tickets/${ticketId}/update_status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message || 'Status atualizado com sucesso!');
            location.reload();
        } else {
            alert(data.error || 'Erro ao atualizar status');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao atualizar status');
    });
}
</script>

<style>
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
</style>
{% endblock %}